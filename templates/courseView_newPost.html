<script>
	function course_submitNewPost() {
		console.log("attempting to create Post...");

		let markdownText = document.getElementById("course_submitNewPostMarkdown").value;

		if (markdownText === "") {
			// prevent from posting an empty post
			// server side checks for this as well
			return
		}


		let formData = new FormData();
		formData.append("markdown", markdownText)

		fetch("/api/version/{{ .Version.ID }}/posts/new", {
			method: "POST",
			body: formData,
		})
		.then(function(resp) {

			// error check
			if (!resp.ok) {
				throw new Error("Response for submitting new Post was not ok!")
				return
			}

			// hide form
			let form = document.getElementById("course_submitNewPostFormMessage");
			form.innerText = "Posted!";

			// hide posting form
			Alpine.store("courseView").allowNewPost = false;
			// delete post data
			document.getElementById("course_submitNewPostMarkdown").value = "";

			console.log("success! new post was sent!");
			SendMessage("Successfully sent post!");

			Alpine.store("progress").increaseProgress();

			return resp.text();
		})
		.then(function(text) {
			console.log(text);
		})
		.catch(function(err) {
			console.error(err);

			// hide posting form
			Alpine.store("courseView").allowNewPost = false;

			// hide form and show message
			let form = document.getElementById("course_submitNewPostFormMessage");
			form.innerText = "Uhh... The internet must have broken... or something... (are you logged in?)";
		});
	}
</script>

<div x-data="{ open: false }" x-show="$store.courseView.allowNewPost">
	<h4 x-show="open === false" @click="open = true" class="bd pad-05 text-center hoverable-bg-code" style="cursor:pointer; width:100%;">
		New Showcase Post
	</h4>
	<h4 x-show="open === true" @click="open = false" class="bd pad-05 text-center hoverable-bg-code" style="cursor:pointer; width:100%;">
		Hide 
		<i class="fa-solid" :class="open ? 'fa-caret-up' : 'fa-caret-down' "></i>
	</h4>
	<div x-show="open">
	{{ if .LoggedIn }}
		<div>
			<textarea class="bd bg-overlay thin-light"  id="course_submitNewPostMarkdown" style="height:30rem; color:var(--c-text); padding: 0.5rem; max-width: 100%; min-width: 100%; min-height: 8rem; border-bottom-right-radius: 0.5rem; border-bottom-left-radius: 0.5rem;" 
			placeholder=
			"Write about what you made   

Make sure you embed at least 1 picture ![embed_example_name](https://embed_example_link)" required></textarea>
		</div>
		<p><span x-text="$store.progress.progress"></span>% done</p>
		<p>Once you write {{ .Release.PostsNeededNum }} showcase posts you will complete the course.</p>
		<button @click="course_submitNewPost();" class="bd bd-none pad-05 hoverable-bg-code" style="cursor:pointer; width: 100%;">Post</button>
	{{ else }}
		<p class="c-grey">You need to login if you want to write a post. Once you write {{ .Release.PostsNeededNum }} showcase posts you will complete the course.</p>
		<a href="/login">Login to write a post</a>
	{{ end }}
	</div>
</div>
<div id="course_submitNewPostFormMessage" x-show="!$store.courseView.allowNewPost">
</div>