{{ template "_header.html" . }}

<div id="courseURL" hidden>/{{ .Course.User.Username }}/{{ .Course.Name }}/view/{{ .Version.ID }}</div>
<div id="courseName" hidden>{{ .Course.Name }}</div>
<div id="versionID" hidden>{{ .Version.ID }}</div>
<div id="sectionID" hidden>{{ .Section.ID }}</div>

<script defer src="/resources/scripts/courseView.js"></script>
<link href="/resources/css/courseView.css" rel="stylesheet">
<link href="/resources/css/courses.css" rel="stylesheet">

<script>
	document.addEventListener("alpine:init", function(event) {
		let courseNext = document.getElementById("courseNext");
		courseNext.addEventListener("click", function() {
			let sections = Alpine.store("sections").sections;
			let current = Alpine.store("sections").current;

			// find index of current
			let index = 0;
			for (let i = 0; i < sections.length; i++) {
				if (sections[i] === current) {
					index = i;
					break
				}
			}

			// prevent from loadin section out of bounds
			let nextSectionIndex = index + 1;
			if ((nextSectionIndex + 1) > sections.length) {
				console.log("out of bounds!")
				console.log("index:", index);
				console.log("nextIndex:", nextSectionIndex);
				console.log("currentID:", current);
				return
			}

			let nextSectionID = Alpine.store("sections").sections[nextSectionIndex];

			console.log("index:", index);
			console.log("nextIndex:", nextSectionIndex);
			console.log("nextID:", nextSectionID);
			console.log("currentID:", current);

			let versionID = document.getElementById("versionID").innerText;
			let courseName = document.getElementById("courseName");

			loadSection(nextSectionID);
		});

		let coursePrev = document.getElementById("coursePrevious");
		coursePrev.addEventListener("click", function() {
			let sections = Alpine.store("sections").sections;
			let current = Alpine.store("sections").current;

			// find index of current
			let index = 0;
			for (let i = 0; i < sections.length; i++) {
				if (sections[i] === current) {
					index = i;
					break
				}
			}

			// prevent from loading section out of bounds
			let previousSectionIndex = index - 1;
			if (previousSectionIndex < 0) {
				console.log("out of bounds!")
				console.log("index:", index);
				console.log("previousIndex:", previousSectionIndex);
				console.log("currentID:", current);
				return
			}

			let previousSectionID = Alpine.store("sections").sections[previousSectionIndex];

			console.log("index:", index);
			console.log("previousIndex:", previousSectionIndex);
			console.log("previousID:", previousSectionID);
			console.log("currentID:", current);

			let versionID = document.getElementById("versionID").innerText;
			let courseName = document.getElementById("courseName");

			loadSection(previousSectionID);
		});

		Alpine.store("sections", {
			sections: [
				// use templating to store info about sections
				{{ range .Version.GetSectionsLogError }}
					{{ .ID }},
				{{ end }}
			],
			current: {{ .Section.ID }},
		});

		console.log("section ids", Alpine.store("sections").sections);
	});
</script>

<div class="pad-sides-5 pad-top-2rem pad-bot-2rem">
	<h1 style="margin-bottom:0;">{{ .Course.Title }}
		<span style="color:var(--c-text); margin-top:2.3rem; font-size:1rem;">v{{ .Release.Num }}.{{ .Version.Num }}.{{ .Version.Patch }}</span>
	</h1>
	<pre style="
	margin-top:1rem;
	overflow-x: auto;
	white-space: pre-wrap;
	white-space: -moz-pre-wrap;
	white-space: -pre-wrap;
	white-space: -o-pre-wrap;
	word-wrap: break-word;">{{ .Course.Subtitle }}</pre>
	{{ if eq .Course.UserID .User.ID }}
		<div style="text-align:right;" >
			<i class="fa-solid fa-gear hoverable-bg-overlay bd" style="padding:0.5rem;" href="/{{ .Course.User.Username }}/{{ .Course.Name }}/settings"></i>
		</div>
	{{ end }}
</div>
<div x-data>
	<div class="pad-sides-5 bg-overlay course-menu" style="display: flex; padding-bottom: 0.5rem; margin-top:0; padding-top:0.5rem; margin-bottom:0; max-width:100%;" id="courseNavTop">
		<!-- dropdown menu -->
		<div x-show="$store.courseView.menuAvailable" @click="toggleMenu()"
		class="bd hoverable"
		style="font-size:1.5rem; cursor:pointer; padding-left:0.6rem; padding-right:0.6rem; padding-top:0.37rem; padding-bottom:0.4rem;">
			<i class="fa-solid fa-list-ul"></i>
		</div>

		<!-- back button when viewing posts or chat or menu to go back to course contents-->
		<div x-cloak x-show="!$store.courseView.menuAvailable && !$store.courseView.viewingPost" @click="viewContents()"
		class="bd hoverable"
		style="font-size:1.5rem; cursor:pointer; padding-left:0.6rem; padding-right:0.6rem; padding-top:0.37rem; padding-bottom:0rem;">
			<i class="fa-solid fa-arrow-left-long"></i>
		</div>

		<!-- back button when viewing specific post to go back to viewing all posts -->
		<div x-cloak x-show="$store.courseView.viewingPost" @click="viewPosts()"
		class="bd hoverable"
		style="font-size:1.5rem; cursor:pointer; padding-left:0.6rem; padding-right:0.6rem; padding-top:0.37rem; padding-bottom:0rem;">
			<i class="fa-solid fa-arrow-left-long"></i>
		</div>

		<div id="sectionTitle"
		style="font-size:1.2rem; white-space: nowrap; text-overflow:hidden; cursor:pointer; padding-left:0.6rem; padding-right:0.6rem; padding-top:0.5rem; padding-bottom:0rem;">
			{{ .Section.Name }}
		</div>

		<!-- view posts -->
		<div @click="viewPosts(); loadPosts({{ .Version.ID }});"
		class="bd hoverable"
		style="font-size:1.5rem; cursor:pointer; padding-left:0.6rem; padding-right:0.6rem; padding-top:0.3rem; margin-left:auto; margin-right:0.5rem;">
			<i class="fa-regular fa-file"></i>
		</div>

		<!-- view chat -->
		<div @click="viewChat()"
		class="bd hoverable"
		style="font-size:1.5rem; cursor:pointer; padding-left:0.4rem; padding-right:0.4rem; padding-top:0.4rem;">
			<i class="fa-regular fa-message"></i>
		</div>
	</div>

	<!-- dropdown menu for course -->
	<div x-cloak x-show="$store.courseView.menuOpen" id="courseMenu" style="padding-top: 2rem; padding-bottom: 3rem; overflow-y: scroll; margin-top:0;" class="bg-overlay pad-sides-5">
		{{ range .Version.GetBaseSectionsLogError }}
			<div :class="$store.sections.current === {{ .ID }} ? 'selected' : ''" class="bd pad-05" @click="loadSection({{ .ID }});">
				{{ .Name }}
			</div>
			<div style="margin-left:2rem;">
				{{ range .GetChildrenSectionsLogError }}
					<div :class="$store.sections.current === {{ .ID }} ? 'selected' : ''" class="bd pad-05" @click="loadSection({{ .ID }});">
						{{ .Name }}
					</div>
					{{ template "courseView_menu.html" . }}
				{{ end }}
			</div>
		{{ end }}
	</div>

	<!-- posts by students -->
	<div x-cloak x-show="$store.courseView.view === 'posts'" class="bg-overlay pad-top-2rem pad-bot-2rem">
		<h1 class="pad-sides-5">Posts</h1>
		<div x-show="$store.courseView.viewingPost" class="pad-sides-5" style="width: 100%;">
			<div class="bg-overlay bd">
				<div style="display:flex;">
					<div style="padding: 0.5rem;">
						by <span id="postMountUser"></span>
					</div>
					<div x-show="$store.courseView.editingPost === false" id="viewEditPostButton" @click="viewEditPost()" style="margin-left:auto; padding: 0.5rem;">
						<i class="fa-solid fa-pen-to-square"></i>
					</div>
					<div x-show="$store.courseView.editingPost === true" @click="$store.courseView.editingPost = false;" style="margin-left:auto; padding: 0.5rem;">
						<i style="margin-left:auto;" class="fa-solid fa-xmark"></i>
					</div>
				</div>
				<div x-show="$store.courseView.editingPost">
					<div hidden id="editPostID"></div>
					<textarea class="bd" id="editPostTextInput" style="max-width:100%; min-width:100%; height:10rem;"></textarea>
					<div>
						<button class="bd bd-none bg-code pad-05" @click="updatePost()">Update</button>
					</div>
				</div>
				<div x-show="!$store.courseView.editingPost" markdown id="postMount" style="padding: 0.5rem; width: 100%;"></div>
			</div>
		</div>
		<!-- when not viewing a specific post, show all posts -->
		<div x-show="!$store.courseView.viewingPost" id="coursePostsMount" class="course-cards">
			<!-- insert posts with js -->
		</div>
	</div>

	<!-- live chat -->
	<div x-cloak x-show="$store.courseView.view === 'chat'" class="bg-overlay pad-top-2rem pad-bot-2rem">
		<h1 class="pad-sides-5">Chat</h1>
		<div>
			{{ template "courseView_chat.html" . }}
		</div>
	</div>

	<!-- course contents-->
	<div x-show="$store.courseView.view === 'contents'" id="courseMain" class="bg-overlay" style="padding-top:1rem; padding-bottom:2rem;">
		<div class="bd thin-light mar-sides-5">
			<div style="display:flex;" class="thin-bot">
				<div class="hoverable pad-05 bd" id="courseContentsLanguage"></div>
				{{ if eq .Course.UserID .User.ID }}
					<div class="hoverable pad-05 bd" x-show="$store.courseView.editingContent === false" @click="$store.courseView.editingContent = ! $store.courseView.editingContent; loadEditSectionPlaintext();" style="margin-left:auto;"><i class="fa-solid fa-pen-to-square"></i></div>
					<div class="hoverable pad-05 bd" x-show="$store.courseView.editingContent === true" @click="$store.courseView.editingContent = ! $store.courseView.editingContent" style="margin-left:auto;"><i style="margin-left:auto;" class="fa-solid fa-xmark"></i></div>
				{{ end }}
			</div>
			<div x-show="$store.courseView.editingContent === false" style="padding-right:2%; padding-left:2%;" id="courseContent">
			</div>
		</div>
		<div x-cloak x-show="$store.courseView.editingContent === true" class="pad-sides-5 bg-overlay">
			<textarea id="courseContentEdit" class="bd" style="max-width:100%; min-width:100%; height:10rem;"></textarea>
			<button id="courseContentEditSaveButton" @click="saveEditSectionContent(); $store.courseView.editingContent = ! $store.courseView.editingContent" class="form-btn bd" style="width:100%">Update</button>
		</div>
		<div class="bg-overlay pad-sides-5" style="padding-top:2rem; padding-bottom:2rem;">
			{{ template "courseView_newPost.html" . }}
		</div>
		<table class="bg-overlay pad-sides-5 pad-bot-2rem" style="width: 100%;">
			<tr>
				<td class="bd bg-overlay thin-light" style="cursor:pointer; padding: 0.5rem; width: 40%; text-align: center;" id="coursePrevious">
					<i class="fa-solid fa-arrow-left-long"></i> Previous Section 
				</td>
				<td style="width:20%;"></td>
				<td class="bd bg-overlay thin-light" style="cursor:pointer; padding: 0.5rem; width: 40%; text-align: center;" id="courseNext">
					Next Section <i class="fa-solid fa-arrow-right-long"></i>
				</td>
			</tr>
		</table>
	</div>
</div>
{{ template "_footer.html" . }}